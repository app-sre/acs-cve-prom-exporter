package exporter

import (
	"log"
	"net/http"

	"github.com/app-sre/acs-cve-prom-exporter/internal/acs"
	"github.com/prometheus/client_golang/prometheus"
	"github.com/prometheus/client_golang/prometheus/promhttp"
)

func Run(endpoint string, token string) int {
	reg := prometheus.NewRegistry()
	signal := make(chan int)
	go acs.Run(reg, endpoint, token, signal)

	go func(signal chan int) {
		http.Handle("/metrics", promhttp.HandlerFor(reg, promhttp.HandlerOpts{}))
		log.Println("Beginning to serve on port :9090")
		if err := http.ListenAndServe(":9090", nil); err != nil {
			log.Println("Error starting server ", err)
			signal <- 1
		}
	}(signal)
	return <-signal
}
